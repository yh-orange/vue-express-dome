# 浏览器相关知识

## 浏览器工作原理
对浏览器的实现者来说，他们做的事情，就是把一个 `URL` 变成一个屏幕上显示的网页。

这个过程是这样的：

1. 浏览器首先使用 `HTTP` 协议或者 `HTTPS` 协议，向服务端请求页面；

2. 把请求回来的 `HTML` 代码经过解析，构建成 `DOM` 树；

3. 计算 `DOM` 树上的 `CSS` 属性；

4. 最后根据 `CSS` 属性对元素逐个进行渲染，得到内存中的位图；

5. 一个可选的步骤是对位图进行合成，这会极大地增加后续绘制的速度；

6. 合成之后，再绘制到界面上。

:::tip TIP

我们要清楚一个事情,从 `HTTP` 请求回来开始，这个过程并非一般想象中的一步做完再做下一步，而是一条流水线。

从 `HTTP` 请求回来，就产生了流式的数据，后续的 `DOM` 树构建、`CSS` `计算`、`渲染`、`合成`、`绘制`，都是尽可能地流式处理前一步的产出：即不需要等到上一步骤完全结束，就开始处理上一步的输出，这样我们在浏览网页时，才会看到逐步出现的页面。
:::

### `HTTP` 协议

浏览器首先要做的事就是根据 `URL` 把数据取回来，取回数据使用的是 `HTTP` 协议，实际上这个过程之前还有 `DNS` 查询，不过这里就不详细展开了,完整的相关阐述查看上文 `HTTP相关知识`。

`HTTP` 协议是基于 `TCP` 协议出现的，对 `TCP` 协议来说，`TCP` 协议是一条双向的通讯通道，`HTTP` 在 `TCP` 的基础上，规定了 `Request-Response` 的模式。这个模式决定了通讯必定是由浏览器端首先发起的。

大部分情况下，浏览器的实现者只需要用一个 `TCP` 库，甚至一个现成的 `HTTP` 库就可以搞定浏览器的网络通讯部分。`HTTP` 是纯粹的文本协议，它是规定了使用 `TCP` 协议来传输文本格式的一个应用层协议。

### `HTTP` 协议格式

`HTTP` 协议，大概可以划分成如下部分。

![HTTP协议](/images/base-js42.png)

### 构建DOM树方式

![构建DOM树方式](/images/base-js43.png)

**解析代码**
`HTML` 的结构不算太复杂，我们日常开发需要的 90% 的“词”（指编译原理的术语 `token`，表示最小的有意义的单元），种类大约只有标签 `开始`、`属性`、`标签结束`、`注释`、`CDATA` 节点几种。

1. 词（`token`）是如何被拆分的

首先我们来看看一个非常标准的标签，会被如何拆分：

```html
<p class="a">text text text</p>
```

如果我们从最小有意义单元的定义来拆分，第一个词（`token`）是什么呢？显然，作为一个词（`token`），整个 `p` 标签肯定是过大了（它甚至可以嵌套）。

那么，只用 `p` 标签的开头是不是合适吗？我们考虑到起始标签也是会包含属性的，最小的意义单元其实是`<p`,所有`<p`是第一个词。

我们继续拆分，可以把这段代码依次拆成词（`token`）：

* `<p`“标签开始”的开始；

* `class=“a`” 属性；

* `>` “标签开始”的结束；

* `text text text` 文本；

* `</p>`标签结束。

根据这样的分析，现在我们讲讲浏览器是如何用代码实现，我们设想，代码开始从 `HTTP` 协议收到的字符流读取字符。

在接受第一个字符之前，我们完全无法判断这是哪一个词（`token`），不过，随着我们接受的字符越来越多，拼出其他的内容可能性就越来越少。

比如，假设我们接受了一个字符`“ < ”` 我们一下子就知道这不是一个文本节点啦。

之后我们再读一个字符，比如就是 `x`，那么我们一下子就知道这不是注释和 `CDATA` 了，接下来我们就一直读，直到遇到“>”或者空格，这样就得到了一个完整的词（`token`）了。

实际上，我们每读入一个字符，其实都要做一次决策，而且这些决定是跟“当前状态”有关的。在这样的条件下，浏览器工程师要想实现把字符流解析成词（`token`），最常见的方案就是使用状态机。

2. 状态机

绝大多数语言的词法部分都是用状态机实现的。那么我们来把部分词（`token`）的解析画成一个状态机看看：

![状态机](/images/base-js44.png)

:::tip TIP

这里是一个简化版的状态机实现图,用来理解状态机运行机制已经够用了,完整版的可以参考[HTML 官方文档](https://html.spec.whatwg.org/),`HTML` 官方文档规定了 80 个状态。
:::

状态机的初始状态，我们仅仅区分 `“< ”`和 `“非 <”`：

* 如果获得的是一个非 < 字符，那么可以认为进入了一个文本节点；

* 如果获得的是一个 < 字符，那么进入一个标签状态。

不过当我们在标签状态时，则会面临着一些可能性。

* 比如下一个字符是“ ! ” ，那么很可能是进入了注释节点或者 CDATA 节点。

* 如果下一个字符是 “/ ”，那么可以确定进入了一个结束标签。

* 如果下一个字符是字母，那么可以确定进入了一个开始标签。

* 如果我们要完整处理各种 HTML 标准中定义的东西，那么还要考虑“ ? ”“% ”等内容。
